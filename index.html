<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Cipher Hunt - IndabaX Sudan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Kufi Arabic', 'Inter', 'sans-serif'],
                        mono: ['Courier New', 'monospace'],
                    },
                    colors: {
                        'indaba-orange': '#f7931e',
                        'indaba-red': '#c1272d',
                        'indaba-purple': '#662d91',
                        'indaba-yellow': '#fcee21',
                        'brand-dark': '#282a36', /* Original Dark */
                        'brand-light': '#ffffff',
                    },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap');

        /* --- Global & Theme Variables --- */
        :root {
            --bg-body: #f8fafc;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --primary-color: #f7931e;
        }

        .dark {
            --bg-body: #282a36;
            --text-main: #f8fafc;
            --text-secondary: #cbd5e1;
            --card-bg: #1e293b;
            --border-color: #44475a;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Noto Kufi Arabic', 'Inter', 'sans-serif';
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100dvh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Canvas Background */
        #game-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }

        /* UI Layer */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            padding-top: 90px;
            /* Header Space */
        }

        /* --- Header (Fixed LTR) --- */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-bottom: 3px solid var(--primary-color);
            z-index: 50;
            padding: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }

        /* --- Cards (Indaba Style) --- */
        .cipher-card {
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            transition: all 0.3s ease;
            position: relative;
        }

        /* --- Inputs & Buttons --- */
        input[type="text"] {
            background-color: var(--bg-body);
            color: var(--text-main);
            border: 2px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s;
            text-align: right;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 147, 30, 0.2);
        }

        /* Buttons */
        button {
            transition: transform 0.1s, filter 0.2s;
        }

        button:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        button:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            display: block;
            margin-top: 10px;
        }

        .btn-skip {
            background-color: transparent;
            border: 2px solid #64748b;
            color: #64748b;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }

        .dark .btn-skip {
            border-color: #94a3b8;
            color: #94a3b8;
        }

        .btn-skip:hover:not(:disabled) {
            background-color: rgba(100, 116, 139, 0.1);
        }

        /* --- Clue Box --- */
        .clue-box {
            background-color: var(--bg-body);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-inline-start: 4px solid var(--primary-color);
        }

        .clue-box img {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 6px;
            margin: 10px auto;
            display: block;
            border: 1px solid var(--border-color);
        }

        /* --- Mission Cards --- */
        .mission-card {
            border: 2px solid transparent;
            background-color: var(--bg-body);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mission-card:hover {
            transform: translateY(-2px);
        }

        .mission-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(247, 147, 30, 0.1);
        }

        /* --- Utilities --- */
        .hidden-d {
            display: none !important;
        }

        .fade-enter {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .timer-badge {
            font-family: 'Courier New', monospace;
            font-weight: 900;
            font-size: 1.4rem;
            color: #c1272d;
        }

        .dark .timer-badge {
            color: #ff6b6b;
        }

        /* Secret Admin Button */
        .secret-admin-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: rgba(128, 128, 128, 0.3);
            font-size: 1.5rem;
            z-index: 99;
            cursor: pointer;
            transition: 0.3s;
        }

        .secret-admin-btn:hover {
            color: var(--primary-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
    </style>
</head>

<body class="dark">

    <!-- Header (Fixed LTR) -->
    <header>
        <div class="container mx-auto flex justify-between items-center max-w-4xl px-4" dir="ltr">
            <!-- Logo Section -->
            <div class="flex items-center gap-3">
                <div
                    class="h-12 w-auto max-w-[200px] flex items-center overflow-hidden rounded-lg border-2 border-indaba-purple p-1 bg-white">
                    <img src="https://i.postimg.cc/439XLGzf/Indaba-Xsudan-2025-Draft-4-Pdf-1-Edited.png"
                        alt="IndabaX Logo" class="object-contain h-full w-full">
                </div>
                <span
                    class="text-2xl font-black text-indaba-purple dark:text-indaba-orange tracking-tight hidden sm:inline-block">IndabaX</span>
            </div>

            <!-- Controls -->
            <div class="flex items-center gap-2">
                <button id="lang-toggle" onclick="toggleLanguage()"
                    class="px-3 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-sm font-bold hover:bg-gray-100 dark:hover:bg-gray-800 text-text-main transition">
                    EN
                </button>
                <button id="theme-toggle" onclick="toggleTheme()"
                    class="p-2 rounded-full text-indaba-orange dark:text-indaba-yellow hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    <i id="theme-icon" class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </header>

    <canvas id="game-canvas"></canvas>

    <button onclick="window.game.adminLogin()" class="secret-admin-btn" title="Admin">
        <i class="fas fa-user-secret"></i>
    </button>

    <div id="ui-layer">

        <!-- Loading -->
        <div id="loading-screen" class="cipher-card flex flex-col items-center text-center">
            <div class="w-12 h-12 border-4 border-indaba-orange border-t-transparent rounded-full animate-spin mb-4">
            </div>
            <h2 class="text-lg font-bold" data-i18n="connecting">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...</h2>
        </div>

        <!-- Main Game Container -->
        <div id="main-game-container" class="cipher-card hidden-d fade-enter">

            <div class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                <h1 class="text-2xl font-bold text-indaba-purple dark:text-white" data-i18n="gameTitle">AI Cipher Hunt
                </h1>
                <div class="score-badge">
                    <i class="fas fa-star text-white"></i> <span id="val-score">0</span>
                </div>
            </div>

            <!-- Start View -->
            <div id="view-start" class="space-y-5">
                <div id="resume-btn-area"
                    class="hidden-d bg-green-100 dark:bg-green-900/30 p-3 rounded-lg border border-green-500 text-center">
                    <p class="text-green-700 dark:text-green-400 text-sm font-bold mb-2" data-i18n="incompleteGame">ŸÑÿØŸäŸÉ
                        ŸÑÿπÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ©!</p>
                    <button onclick="window.game.resume()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg shadow">
                        <i class="fas fa-play-circle ml-2"></i> <span data-i18n="resume">ÿßÿ≥ÿ™ŸÉŸÖÿßŸÑ</span>
                    </button>
                </div>

                <!-- Mission Selection (Updated Names) -->
                <div id="mission-selector-container">
                    <label class="block text-sm font-bold text-text-secondary mb-2" data-i18n="choosePath">ÿßÿÆÿ™ÿ±
                        ÿßŸÑŸÖÿ≥ÿßÿ±:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="window.game.selectMission('mission_sam')" id="m-mission_sam"
                            class="mission-card selected">
                            <div class="text-indaba-orange text-3xl mb-2"><i class="fas fa-robot"></i></div>
                            <div class="font-bold text-sm" data-i18n="pathSam">Mystery 1</div>
                        </div>
                        <div onclick="window.game.selectMission('mission_turing')" id="m-mission_turing"
                            class="mission-card">
                            <div class="text-blue-500 text-3xl mb-2"><i class="fas fa-code"></i></div>
                            <div class="font-bold text-sm" data-i18n="pathTuring">Mystery 2</div>
                        </div>
                    </div>
                </div>

                <!-- Forced Mission -->
                <div id="forced-mission-display"
                    class="hidden-d text-center bg-gray-100 dark:bg-gray-800 p-4 rounded-xl border-2 border-dashed border-gray-400">
                    <p class="text-text-secondary text-sm font-bold mb-1" data-i18n="currentMission">ÿßŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:</p>
                    <h3 id="forced-mission-name" class="text-xl font-black text-indaba-orange">...</h3>
                </div>

                <div class="space-y-3">
                    <input type="text" id="inp-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ" class="text-start">
                    <input type="text" id="inp-username" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" class="text-start">
                </div>

                <button onclick="window.game.start()" class="btn-primary">
                    <span data-i18n="startChallenge">ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ÿØŸä</span> <i
                        class="fas fa-arrow-left mr-2 rtl:rotate-0 ltr:rotate-180"></i>
                </button>
            </div>

            <!-- Level View -->
            <div id="view-level" class="hidden-d">
                <div
                    class="flex justify-between items-center mb-4 bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <span class="text-xs font-bold text-text-secondary uppercase">
                        <span data-i18n="level">ŸÖÿ≥ÿ™ŸàŸâ</span> <span id="val-level"
                            class="text-indaba-purple dark:text-white text-lg">1</span>
                    </span>
                    <div class="timer-badge" id="txt-timer">00:00</div>
                </div>

                <div class="clue-box mb-4 relative overflow-hidden min-h-[150px] flex flex-col justify-center">
                    <!-- Text Clue (For normal questions) -->
                    <div id="level-content-text" class="text-lg font-bold text-center dir-ltr mb-3 leading-relaxed">
                    </div>

                    <!-- Image Clue -->
                    <img id="level-content-img" class="hidden-d" alt="Clue">

                    <!-- HTML Content -->
                    <div id="level-content-html"
                        class="text-left dir-ltr text-sm font-mono hidden-d bg-white dark:bg-black/20 p-3 rounded border border-gray-300 dark:border-gray-600">
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <p id="hint-text" class="text-center text-indaba-orange font-bold text-sm mb-2"></p>
                    <input type="text" id="inp-answer" placeholder="..." class="text-center font-bold text-lg dir-ltr">

                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="window.game.check()" class="btn-primary">
                            <span data-i18n="check">ÿ™ÿ≠ŸÇŸÇ</span> <i class="fas fa-check ml-2"></i>
                        </button>
                        <button onclick="window.game.skip()" class="btn-skip">
                            <span data-i18n="skip">ÿ™ÿÆÿ∑Ÿä</span>
                        </button>
                    </div>
                </div>

                <div id="msg-box" class="mt-4 text-center font-bold text-sm p-3 rounded-lg hidden-d"></div>
            </div>

            <!-- Win View -->
            <div id="view-win" class="hidden-d text-center">
                <div class="relative w-32 h-32 mx-auto mb-4">
                    <div class="absolute inset-0 bg-indaba-orange rounded-full animate-ping opacity-20"></div>
                    <img id="img-reveal"
                        class="w-full h-full object-cover rounded-full border-4 border-indaba-orange shadow-lg relative z-10"
                        src="">
                </div>
                <h2 class="text-3xl font-black text-indaba-orange mb-2" id="txt-reveal-name"></h2>
                <p class="text-text-secondary mb-6 font-medium" data-i18n="revealSuccess">ÿ™ŸÖ ŸÉÿ¥ŸÅ ÿßŸÑŸáŸàŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ</p>
                <button onclick="window.game.showScoreboard()"
                    class="btn-primary bg-green-600 hover:bg-green-700 !important">
                    <span data-i18n="viewLeaderboard">ÿπÿ±ÿ∂ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</span> <i class="fas fa-trophy mr-2"></i>
                </button>
            </div>

            <!-- Game Over View -->
            <div id="view-over" class="hidden-d text-center">
                <i class="fas fa-hourglass-end text-6xl text-indaba-red mb-4 animate-pulse"></i>
                <h2 class="text-2xl font-bold mb-2" data-i18n="timeUp">ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!</h2>
                <div class="text-3xl font-black text-indaba-orange my-4">
                    <span class="text-xs text-text-secondary block mb-1" data-i18n="totalScore">ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸÇÿßÿ∑</span>
                    <span id="score-final">0</span>
                </div>
                <button onclick="window.game.showScoreboard()" class="btn-primary">
                    <span data-i18n="viewResults">ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</span>
                </button>
            </div>
        </div>

        <!-- Scoreboard Container -->
        <div id="scoreboard-container" class="cipher-card hidden-d fade-enter flex flex-col h-[70vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-indaba-orange" data-i18n="leaderboard">ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ŸÜÿßŸÅÿ≥ŸäŸÜ</h2>
                <button onclick="window.game.reset()" class="text-gray-400 hover:text-indaba-red transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="sb-body"></div>
            <div class="mt-4 pt-2 border-t border-gray-200 dark:border-gray-700 text-center">
                <button onclick="window.game.reset()" class="text-sm font-bold text-indaba-orange hover:underline">
                    <i class="fas fa-home mr-1"></i> <span data-i18n="backHome">ÿßŸÑÿπŸàÿØÿ©</span>
                </button>
            </div>
        </div>
    </div>

    <!-- UI Logic: Translations & Theme -->
    <script>
        const translations = {
            ar: {
                gameTitle: "AI Cipher Hunt", connecting: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...", incompleteGame: "ŸÑÿØŸäŸÉ ŸÑÿπÿ®ÿ© ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ©!", resume: "ÿßÿ≥ÿ™ŸÉŸÖÿßŸÑ", choosePath: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿßÿ±:", pathSam: "Mystery 1", pathTuring: "Mystery 2", currentMission: "ÿßŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:", fullName: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ", username: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ", startChallenge: "ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ÿØŸä", level: "ŸÖÿ≥ÿ™ŸàŸâ", check: "ÿ™ÿ≠ŸÇŸÇ", skip: "ÿ™ÿÆÿ∑Ÿä", revealSuccess: "ÿ™ŸÖ ŸÉÿ¥ŸÅ ÿßŸÑŸáŸàŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ", viewLeaderboard: "ÿπÿ±ÿ∂ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", timeUp: "ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!", totalScore: "ÿßŸÑŸÜŸÇÿßÿ∑", viewResults: "ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨", leaderboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ŸÜÿßŸÅÿ≥ŸäŸÜ", backHome: "ÿßŸÑÿπŸàÿØÿ©", phAnswer: "ÿ£ÿØÿÆŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©...", phName: "ÿßŸÑÿßÿ≥ŸÖ", phUser: "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ", whoIs: "ŸÖŸÜ ŸáŸä ÿßŸÑÿ¥ÿÆÿµŸäÿ©ÿü"
            },
            en: {
                gameTitle: "AI Cipher Hunt", connecting: "Connecting...", incompleteGame: "Game in progress found!", resume: "Resume", choosePath: "Choose Path:", pathSam: "Mystery 1", pathTuring: "Mystery 2", currentMission: "Current Mission:", fullName: "Full Name", username: "Username", startChallenge: "Start Challenge", level: "Level", check: "Check", skip: "Skip", revealSuccess: "Identity Revealed! üéâ", viewLeaderboard: "Leaderboard", timeUp: "Time's Up!", totalScore: "Score", viewResults: "View Results", leaderboard: "Leaderboard", backHome: "Back Home", phAnswer: "Enter answer...", phName: "Full Name", phUser: "Username", whoIs: "Who is the character?"
            }
        };

        let currentLang = 'ar';
        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-toggle').innerText = currentLang === 'ar' ? 'EN' : 'ÿπÿ±ÿ®Ÿä';

            // Translate Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) el.innerText = translations[currentLang][key];
            });

            // Update Input Directions & Placeholders
            const inputs = document.querySelectorAll('input[type="text"]');
            const t = translations[currentLang];
            inputs.forEach(inp => {
                // If it's a game answer, keep LTR usually for code/english answers, 
                // but for name/username switch direction.
                if (inp.id === 'inp-answer') {
                    // Game answers are usually English (Codes), so we keep LTR mostly,
                    // but placeholders update.
                    inp.placeholder = t.phAnswer;
                } else {
                    // Name fields
                    inp.style.textAlign = currentLang === 'ar' ? 'right' : 'left';
                    if (inp.id === 'inp-name') inp.placeholder = t.phName;
                    if (inp.id === 'inp-username') inp.placeholder = t.phUser;
                }
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Force redraw canvas background
            if (window.drawBackgroundOnce) window.drawBackgroundOnce();
        }

        // Init Theme
        if (localStorage.getItem('theme') !== 'light') {
            document.body.classList.add('dark');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }
    </script>

    <!-- Game Engine Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d');
        let width, height, nodes = [], time = 0;

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; initNodes(); }
        function initNodes() { nodes = []; const count = Math.floor((width * height) / 15000); for (let i = 0; i < count; i++) nodes.push({ x: Math.random() * width, y: Math.random() * height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, size: Math.random() * 2 + 1 }); }

        function drawBackground() {
            const isDark = document.body.classList.contains('dark');
            ctx.fillStyle = isDark ? '#282a36' : '#f8fafc';
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = 'rgba(247, 147, 30, 0.3)';
            ctx.strokeStyle = 'rgba(247, 147, 30, 0.05)';

            for (let i = 0; i < nodes.length; i++) { let node = nodes[i]; node.x += node.vx; node.y += node.vy; if (node.x < 0 || node.x > width) node.vx *= -1; if (node.y < 0 || node.y > height) node.vy *= -1; ctx.beginPath(); ctx.arc(node.x, node.y, node.size, 0, Math.PI * 2); ctx.fill(); for (let j = i + 1; j < nodes.length; j++) { let other = nodes[j]; let dist = Math.sqrt(Math.pow(node.x - other.x, 2) + Math.pow(node.y - other.y, 2)); if (dist < 100) { ctx.beginPath(); ctx.moveTo(node.x, node.y); ctx.lineTo(other.x, other.y); ctx.stroke(); } } }
            if (window.game && window.game.timeLeft > 0 && window.game.isPlaying) drawTimerRing();
            requestAnimationFrame(drawBackground);
        }
        window.drawBackgroundOnce = () => { };

        function drawTimerRing() { const pct = window.game.timeLeft / window.game.maxTime, cx = width / 2, cy = height / 2, radius = Math.min(width, height) * 0.45; ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI * 2); ctx.strokeStyle = 'rgba(128,128,128,0.05)'; ctx.lineWidth = 6; ctx.stroke(); ctx.beginPath(); ctx.arc(cx, cy, radius, -Math.PI / 2, (-Math.PI / 2) + (Math.PI * 2 * pct)); ctx.strokeStyle = pct < 0.2 ? '#c1272d' : '#f7931e'; ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.stroke(); }
        window.addEventListener('resize', resize); resize(); drawBackground();

        // ** UPDATED MISSIONS DATA BASED ON IMAGE ** //
        const MISSIONS = {
            "mission_sam": {
                name: "Mystery 1",
                data: [
                    // Level 1: Caesar Cipher
                    { type: 'text', content: "Gpdvt jt b gpsdf nvmujqmjfs po xpsk", hint: "ÿ¥ŸÅÿ±ÿ© ŸÇŸäÿµÿ± (+1)", ans: "FOCUS IS A FORCE MULTIPLIER ON WORK", pts: 10, time: 240 },
                    // Level 2: Loopt (Updated Hint)
                    { type: 'img', content: "https://i.postimg.cc/28yNzmPC/Whats-App-Image-2025-10-28-at-03-06-32-1fc29a72.jpg", hint: "ŸÖÿßÿ∞ÿß ŸäÿπŸÜŸä ŸÉŸÑ ÿ≠ÿ±ŸÅ ŸÖŸÜ Ÿáÿ∞Ÿá ÿßŸÑŸÉŸÑŸÖÿ©ÿü\nWhat does each letter of this word mean?", ans: "LOCATION BASED SOCIAL APP", pts: 5, time: 120 },
                    // Level 3: Crack the Code
                    { type: 'img', content: "https://i.postimg.cc/ZKnzTZ1q/Whats-App-Image-2025-10-28-at-03-06-32-b3091846.jpg", hint: "ÿßŸÉÿ≥ÿ± ÿßŸÑÿ±ŸÖÿ≤", ans: "3841", pts: 15, time: 600 },
                    // Level 4: Wait screen (Updated Hint)
                    { type: 'img', content: "https://i.postimg.cc/FszX9m2S/Whats-App-Image-2025-10-28-at-03-06-32-2c52cb2b.jpg", hint: "...ÿßŸÜÿ™ÿ∏ÿ±", ans: null, pts: 0, time: 40 },
                    // Level 5: Address
                    { type: 'html', content: `<p class="font-bold">3180 18th Street,</p><p>San Francisco, CA</p>`, hint: "ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∏ŸÖÿ©ÿü", ans: "OPEN AI", pts: 5, time: 180 },
                    // Level 6: Final (Updated Hint)
                    { type: 'final_question', content: "Who is the character?", hint: "???", ans: "SAM ALTMAN", pts: 0, time: 999, revealImg: "https://i.postimg.cc/wTMY6HSv/Whats-App-Image-2025-10-28-at-03-06-32-bb976a41.jpg" }
                ]
            },
            "mission_turing": {
                name: "Mystery 2",
                data: [
                    { type: 'text', content: "NBDIJOFT DBO UIJOL", hint: "ÿ¥ŸÅÿ±ÿ© ŸÇŸäÿµÿ± (+1)", ans: "MACHINES CAN THINK", pts: 10, time: 240 },
                    { type: 'img', content: "https://placehold.co/600x400/0f172a/FFF?text=Enigma+Machine", hint: "ÿßÿ≥ŸÖ ÿßŸÑÿ¢ŸÑÿ©ÿü", ans: "ENIGMA", pts: 5, time: 120 },
                    { type: 'text', content: "1950", hint: "ÿ≥ŸÜÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™Ÿàÿ±ŸäŸÜÿ¨", ans: "1950", pts: 15, time: 600 },
                    { type: 'text', content: "Wait...", hint: "Loading...", ans: null, pts: 0, time: 40 },
                    { type: 'html', content: "<p class='font-bold'>Bletchley Park, UK</p>", hint: "ÿßŸÑŸÖŸÉÿßŸÜÿü", ans: "BLETCHLEY PARK", pts: 5, time: 180 },
                    { type: 'final_question', content: "Who is the character?", hint: "???", ans: "ALAN TURING", pts: 0, time: 999, revealImg: "https://placehold.co/300x300/e66d15/FFF?text=Turing" }
                ]
            }
        };

        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDTuocX-lCYRMrgFQLnSzKcpnQnL2sLHs0",
                authDomain: "ai-cipher-hunt-p2.firebaseapp.com",
                projectId: "ai-cipher-hunt-p2",
                storageBucket: "ai-cipher-hunt-p2.firebasestorage.app",
                messagingSenderId: "539746998922",
                appId: "1:539746998922:web:579ec59bc94a0a4d9aab73",
                measurementId: "G-ENP1QLMEKD"
            }
        };

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : CONFIG.firebase.projectId;

        class GameEngine {
            constructor() { this.state = { missionId: 'mission_sam', levelIdx: 0, score: 0, name: '', username: '', isPlaying: false }; this.timer = null; this.timeLeft = 0; this.maxTime = 100; this.db = null; this.userId = null; this.isConfigControlled = false; }
            async init() {
                if (CONFIG.firebase.projectId) {
                    const app = initializeApp(CONFIG.firebase); this.db = getFirestore(app); const auth = getAuth(app); await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => { this.userId = u ? u.uid : 'guest'; this.listenToConfig(); });
                } else { this.userId = 'offline'; this.onReady(); }
            }
            listenToConfig() {
                const configRef = doc(this.db, "artifacts", APP_ID, "public", "data", "game_config", "status");
                onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const activeId = docSnap.data().active_mission_id;
                        this.applyConfig(activeId);
                    } else {
                        this.applyConfig('SELECTION_MODE');
                    }
                    this.onReady();
                }, (error) => {
                    console.warn("Config fetch fallback (offline mode):", error);
                    this.applyConfig('SELECTION_MODE');
                    this.onReady();
                });
            }
            applyConfig(activeId) {
                const selector = document.getElementById('mission-selector-container');
                const forcedDisplay = document.getElementById('forced-mission-display');
                if (selector && forcedDisplay) {
                    if (activeId && activeId !== 'SELECTION_MODE' && MISSIONS[activeId]) {
                        this.isConfigControlled = true;
                        this.state.missionId = activeId;
                        selector.classList.add('hidden-d');
                        forcedDisplay.classList.remove('hidden-d');
                        if (document.getElementById('forced-mission-name'))
                            document.getElementById('forced-mission-name').innerText = MISSIONS[activeId].name;
                    } else {
                        this.isConfigControlled = false;
                        selector.classList.remove('hidden-d');
                        forcedDisplay.classList.add('hidden-d');
                    }
                }
            }
            onReady() {
                const loader = document.getElementById('loading-screen');
                const main = document.getElementById('main-game-container');
                if (loader) loader.classList.add('hidden-d');
                if (main) main.classList.remove('hidden-d');

                const saved = localStorage.getItem('indabax_canvas_v3');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.levelIdx > 0 && parsed.levelIdx < 6) {
                            this.state = parsed;
                            const resumeBtn = document.getElementById('resume-btn-area');
                            if (resumeBtn) resumeBtn.classList.remove('hidden-d');
                        }
                    } catch (e) { localStorage.removeItem('indabax_canvas_v3'); }
                }
            }
            selectMission(id) {
                if (this.isConfigControlled) return;
                this.state.missionId = id;
                document.querySelectorAll('.mission-card').forEach(el => el.classList.remove('selected'));
                const card = document.getElementById(`m-${id}`);
                if (card) card.classList.add('selected');
            }
            start() {
                const name = document.getElementById('inp-name').value.trim(); const user = document.getElementById('inp-username').value.trim();
                if (!name || !user) return alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                this.state = { ...this.state, name, username: user, score: 0, levelIdx: 0 }; this.save(); this.renderLevel();
            }
            resume() { this.renderLevel(); }
            save() { localStorage.setItem('indabax_canvas_v3', JSON.stringify(this.state)); }

            adminLogin() {
                const pass = prompt("üîí ŸÑŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖÿå ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤:");
                if (pass === "INNOVATE") { window.location.href = "admin.html"; }
                else if (pass !== null) { alert("‚ùå ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ ÿÆÿßÿ∑ÿ¶!"); }
            }

            renderLevel() {
                this.state.isPlaying = true;
                if (document.getElementById('view-start')) document.getElementById('view-start').classList.add('hidden-d');
                if (document.getElementById('view-level')) document.getElementById('view-level').classList.remove('hidden-d');
                if (document.getElementById('ui-level-indicator')) document.getElementById('ui-level-indicator').classList.remove('hidden-d');

                const levelData = MISSIONS[this.state.missionId].data[this.state.levelIdx];
                if (document.getElementById('val-score')) document.getElementById('val-score').innerText = this.state.score;
                if (document.getElementById('val-level')) document.getElementById('val-level').innerText = this.state.levelIdx + 1;

                const txtEl = document.getElementById('level-content-text'), imgEl = document.getElementById('level-content-img'), htmlEl = document.getElementById('level-content-html'), hintEl = document.getElementById('hint-text');
                if (txtEl) txtEl.innerText = "";
                if (imgEl) imgEl.classList.add('hidden-d');
                if (htmlEl) htmlEl.classList.add('hidden-d');
                if (document.getElementById('msg-box')) document.getElementById('msg-box').classList.add('hidden-d');
                if (document.getElementById('inp-answer')) {
                    document.getElementById('inp-answer').value = "";
                    document.getElementById('inp-answer').disabled = false;
                }

                // Show Hint in UI
                if (hintEl) {
                    hintEl.innerText = levelData.hint || "";
                }

                if (levelData.type === 'text' || levelData.type === 'final_question') {
                    // For final_question, we use a specific localized text or default to content
                    if (levelData.type === 'final_question') {
                        // Check active language for the specific question
                        // Ideally retrieve from translations object, but here we can just use the content prop which acts as key or text
                        txtEl.innerText = translations[currentLang].whoIs || levelData.content;
                    } else {
                        txtEl.innerText = levelData.content;
                    }
                }
                else if (levelData.type === 'img') {
                    imgEl.src = levelData.content; imgEl.classList.remove('hidden-d');
                }
                else if (levelData.type === 'html') {
                    htmlEl.innerHTML = levelData.content; htmlEl.classList.remove('hidden-d');
                }
                // Removed 'reveal' auto-trigger. Now 'final_question' handles input, then triggers win.

                if (this.timer) clearInterval(this.timer);
                this.maxTime = this.timeLeft = levelData.time;
                this.updateTimerUI();

                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerUI();
                    if (this.timeLeft <= 0) {
                        clearInterval(this.timer);
                        if (levelData.ans === null) this.nextLevel();
                        else this.gameOver();
                    }
                }, 1000);
            }
            updateTimerUI() { const min = Math.floor(this.timeLeft / 60).toString().padStart(2, '0'), sec = (this.timeLeft % 60).toString().padStart(2, '0'); if (document.getElementById('txt-timer')) document.getElementById('txt-timer').innerText = `${min}:${sec}`; }
            check() {
                const levelData = MISSIONS[this.state.missionId].data[this.state.levelIdx];
                if (document.getElementById('inp-answer').value.trim().toUpperCase() === levelData.ans) {
                    this.state.score += levelData.pts;
                    this.showMsg('success', 'ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©!');
                    confetti({ origin: { y: 0.7 } });

                    // Check if this was the final question
                    if (levelData.type === 'final_question') {
                        setTimeout(() => this.showWin(levelData), 1500);
                    } else {
                        setTimeout(() => this.nextLevel(), 1500);
                    }
                } else {
                    this.showMsg('error', 'ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                }
            }
            skip() {
                const levelData = MISSIONS[this.state.missionId].data[this.state.levelIdx];
                this.showMsg('error', 'ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ');

                if (levelData.type === 'final_question') {
                    // Skipping final question reveals the answer anyway? Or game over?
                    // Usually skips lead to next level. If it's final, maybe just end game or show win with 0 pts for that level.
                    // Let's assume skip on final reveals the char.
                    setTimeout(() => this.showWin(levelData), 1000);
                } else {
                    setTimeout(() => this.nextLevel(), 1000);
                }
            }
            nextLevel() { this.state.levelIdx++; this.save(); this.renderLevel(); }
            showMsg(type, txt) {
                const box = document.getElementById('msg-box');
                if (!box) return;
                box.innerText = txt;
                box.className = `mt-4 text-center font-bold text-sm p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                box.classList.remove('hidden-d');
            }
            showWin(data) {
                this.state.isPlaying = false;
                if (document.getElementById('view-level')) document.getElementById('view-level').classList.add('hidden-d');
                if (document.getElementById('view-win')) document.getElementById('view-win').classList.remove('hidden-d');

                // Use the revealImg property for the final image
                if (document.getElementById('img-reveal')) document.getElementById('img-reveal').src = data.revealImg || data.content;
                if (document.getElementById('txt-reveal-name')) document.getElementById('txt-reveal-name').innerText = data.ans;

                this.uploadScore('WIN'); localStorage.removeItem('indabax_canvas_v3'); confetti({ particleCount: 100, spread: 70 });
            }
            gameOver() {
                this.state.isPlaying = false;
                if (document.getElementById('view-level')) document.getElementById('view-level').classList.add('hidden-d');
                if (document.getElementById('view-over')) document.getElementById('view-over').classList.remove('hidden-d');
                if (document.getElementById('score-final')) document.getElementById('score-final').innerText = this.state.score;
                this.uploadScore('TIME_UP'); localStorage.removeItem('indabax_canvas_v3');
            }
            async uploadScore(status) {
                if (!this.db) return;
                try { await addDoc(collection(this.db, "artifacts", APP_ID, "public", "data", "cipher_scores"), { name: this.state.username, realName: this.state.name, score: this.state.score, mission: MISSIONS[this.state.missionId].name, status, timestamp: serverTimestamp() }); } catch (e) { }
            }
            showScoreboard() {
                document.getElementById('main-game-container').classList.add('hidden-d'); document.getElementById('scoreboard-container').classList.remove('hidden-d');
                if (!this.db) return;
                onSnapshot(query(collection(this.db, "artifacts", APP_ID, "public", "data", "cipher_scores")), (snap) => {
                    const list = []; snap.forEach(d => list.push(d.data())); list.sort((a, b) => b.score - a.score);
                    const body = document.getElementById('sb-body');
                    if (body) {
                        body.innerHTML = "";
                        list.forEach((p, i) => {
                            const div = document.createElement('div'); div.className = "flex justify-between items-center p-3 mb-2 bg-white/10 rounded-lg border border-gray-700";
                            div.innerHTML = `<div class="flex items-center gap-3"><span class="font-mono text-orange-400 font-bold">#${i + 1}</span><div><div class="font-bold text-sm text-gray-200">${p.name}</div><div class="text-xs text-slate-400">${p.mission || 'N/A'}</div></div></div><div class="font-bold text-lg dark:text-white text-gray-900">${p.score}</div>`;
                            body.appendChild(div);
                        });
                    }
                });
            }
            reset() { location.reload(); }
        }
        window.game = new GameEngine(); window.game.init();
    </script>
</body>

</html>
